<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BroAi // Edge AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0a0c0f;
    --panel:    #0f1318;
    --border:   #1e2730;
    --accent:   #00ff9d;
    --accent2:  #0090ff;
    --danger:   #ff3860;
    --text:     #c8d6e5;
    --muted:    #4a5568;
    --user-bg:  #0d1f1a;
    --ai-bg:    #0d1520;
    --mono:     'Share Tech Mono', monospace;
    --sans:     'Barlow', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-weight: 300;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    height: 52px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--panel);
    position: relative;
  }
  header::after {
    content: '';
    position: absolute;
    bottom: -1px; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.4;
  }
  .logo {
    font-family: var(--mono);
    font-size: 1rem;
    color: var(--accent);
    letter-spacing: 0.08em;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .logo-icon {
    font-size: 1.3rem;
    animation: pulse 3s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; } 50% { opacity: 0.5; }
  }
  .header-meta {
    display: flex;
    align-items: center;
    gap: 1.2rem;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
    display: inline-block;
    margin-right: 5px;
    transition: background 0.4s;
  }
  .status-dot.online { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .status-dot.thinking { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); animation: blink 0.6s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  /* â”€â”€ CHAT WINDOW â”€â”€ */
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    scroll-behavior: smooth;
  }
  #chat::-webkit-scrollbar { width: 4px; }
  #chat::-webkit-scrollbar-track { background: transparent; }
  #chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    display: flex;
    flex-direction: column;
    max-width: 80%;
    animation: fadeUp 0.25s ease both;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .msg.user { align-self: flex-end; align-items: flex-end; }
  .msg.ai   { align-self: flex-start; align-items: flex-start; }

  .msg-label {
    font-family: var(--mono);
    font-size: 0.62rem;
    letter-spacing: 0.12em;
    margin-bottom: 0.35rem;
    text-transform: uppercase;
  }
  .msg.user .msg-label { color: var(--accent); }
  .msg.ai   .msg-label { color: var(--accent2); }

  .msg-bubble {
    padding: 0.75rem 1rem;
    border-radius: 2px;
    font-size: 0.92rem;
    line-height: 1.65;
    font-weight: 400;
    word-break: break-word;
    white-space: pre-wrap;
    position: relative;
  }
  .msg.user .msg-bubble {
    background: var(--user-bg);
    border: 1px solid #1a3d2e;
    border-right: 3px solid var(--accent);
  }
  .msg.ai .msg-bubble {
    background: var(--ai-bg);
    border: 1px solid #0d2035;
    border-left: 3px solid var(--accent2);
  }

  .msg-meta {
    font-family: var(--mono);
    font-size: 0.6rem;
    color: var(--muted);
    margin-top: 0.3rem;
  }

  /* thinking indicator */
  .thinking-bubble {
    display: flex;
    gap: 5px;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--ai-bg);
    border: 1px solid #0d2035;
    border-left: 3px solid var(--accent2);
  }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent2); }
  .dot:nth-child(1) { animation: bounce 1.2s 0s   infinite; }
  .dot:nth-child(2) { animation: bounce 1.2s 0.2s infinite; }
  .dot:nth-child(3) { animation: bounce 1.2s 0.4s infinite; }
  @keyframes bounce {
    0%,80%,100% { transform: translateY(0); opacity:0.4; }
    40%         { transform: translateY(-6px); opacity:1; }
  }

  /* system info banner */
  .sys-banner {
    align-self: center;
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 0.4rem 1rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border-radius: 2px;
  }

  /* â”€â”€ INPUT BAR â”€â”€ */
  .input-bar {
    flex-shrink: 0;
    border-top: 1px solid var(--border);
    background: var(--panel);
    padding: 1rem 1.5rem;
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
  }
  .input-wrap {
    flex: 1;
    position: relative;
  }
  textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 0.92rem;
    font-weight: 300;
    padding: 0.7rem 1rem;
    resize: none;
    outline: none;
    line-height: 1.5;
    max-height: 160px;
    overflow-y: auto;
    transition: border-color 0.2s;
  }
  textarea:focus { border-color: var(--accent2); }
  textarea::placeholder { color: var(--muted); }

  .send-btn {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    padding: 0.7rem 1.2rem;
    cursor: pointer;
    border-radius: 2px;
    text-transform: uppercase;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    white-space: nowrap;
    height: 42px;
  }
  .send-btn:hover:not(:disabled) {
    background: var(--accent);
    color: var(--bg);
    box-shadow: 0 0 16px rgba(0,255,157,0.3);
  }
  .send-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  /* â”€â”€ SETTINGS ROW â”€â”€ */
  .settings-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 0.5rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--panel);
    flex-shrink: 0;
  }
  .setting {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--mono);
    font-size: 0.67rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .setting select, .setting input[type=number] {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.67rem;
    padding: 0.2rem 0.4rem;
    border-radius: 2px;
    outline: none;
  }
  .setting input[type=number] { width: 60px; }
  .clear-btn {
    margin-left: auto;
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    padding: 0.2rem 0.7rem;
    cursor: pointer;
    border-radius: 2px;
    text-transform: uppercase;
    transition: background 0.2s;
  }
  .clear-btn:hover { background: var(--danger); color: var(--bg); }

  /* â”€â”€ STATS BAR â”€â”€ */
  #stats {
    display: none;
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
    padding: 0.3rem 1.5rem;
    background: var(--panel);
    border-top: 1px solid var(--border);
    gap: 1.5rem;
    flex-shrink: 0;
  }
  #stats.visible { display: flex; }
  #stats span { color: var(--accent); }

  @media (max-width: 600px) {
    .msg { max-width: 95%; }
    .settings-row { flex-wrap: wrap; gap: 0.6rem; }
    .header-meta { display: none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-icon">ðŸ¦€</span>
    FABIO-CLAW // EDGE AI
  </div>
  <div class="header-meta">
    <div id="status-text">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-label">CONNECTING</span>
    </div>
    <div id="device-id">DEVICE: â€”</div>
    <div id="model-name">MODEL: â€”</div>
  </div>
</header>

<div id="chat">
  <div class="sys-banner">FABIO-CLAW v0.1.0 // LOCAL INFERENCE // OFFLINE-CAPABLE</div>
</div>

<div id="stats">
  LAST: <span id="stat-time">â€”</span>ms &nbsp;|&nbsp;
  PROMPT: <span id="stat-prompt">â€”</span> tokens &nbsp;|&nbsp;
  COMPLETION: <span id="stat-completion">â€”</span> tokens &nbsp;|&nbsp;
  TOTAL: <span id="stat-total">â€”</span> tokens
</div>

<div class="settings-row">
  <div class="setting">
    MAX TOKENS
    <input type="number" id="max-tokens" value="256" min="10" max="2048" step="10">
  </div>
  <div class="setting">
    SYSTEM PROMPT
    <input type="text" id="system-prompt" value="You are a helpful assistant running on edge hardware."
      style="width:280px; font-size:0.67rem; padding:0.2rem 0.5rem;">
  </div>
  <button class="clear-btn" onclick="clearChat()">CLEAR</button>
</div>

<div class="input-bar">
  <div class="input-wrap">
    <textarea id="input" rows="1" placeholder="Type a messageâ€¦ (Enter to send, Shift+Enter for newline)"></textarea>
  </div>
  <button class="send-btn" id="send-btn" onclick="sendMessage()">SEND â–¶</button>
</div>

<script>
  // â”€â”€ CONFIG â”€â”€
  // If the HTML is served from the same host as the API, use relative URL.
  // If opened as a local file, point to the Pi's IP directly.
  const API_BASE = window.location.hostname === 'localhost' || window.location.hostname !== ''
    ? `http://${window.location.hostname || 'localhost'}:8080`
    : 'http://localhost:8080';

  let messages = [];
  let thinking = null;

  // â”€â”€ INIT â”€â”€
  async function init() {
    try {
      const [health, models] = await Promise.all([
        fetch(`${API_BASE}/health`).then(r => r.json()),
        fetch(`${API_BASE}/v1/models`).then(r => r.json()),
      ]);
      setStatus('online');
      document.getElementById('device-id').textContent =
        'DEVICE: ' + health.device_id.slice(0, 12) + 'â€¦';
      const modelId = models.data?.[0]?.id ?? 'unknown';
      document.getElementById('model-name').textContent = 'MODEL: ' + modelId.toUpperCase();
    } catch {
      setStatus('offline');
    }
  }

  function setStatus(s) {
    const dot = document.getElementById('status-dot');
    const label = document.getElementById('status-label');
    dot.className = 'status-dot ' + s;
    label.textContent = s.toUpperCase();
  }

  // â”€â”€ SEND â”€â”€
  async function sendMessage() {
    const input = document.getElementById('input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    input.style.height = 'auto';
    document.getElementById('send-btn').disabled = true;
    setStatus('thinking');

    addMsg('user', text);

    const systemPrompt = document.getElementById('system-prompt').value.trim();
    const maxTokens = parseInt(document.getElementById('max-tokens').value) || 256;

    const payload = {
      model: 'local',
      messages: [
        ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
        ...messages,
      ],
      max_tokens: maxTokens,
    };

    thinking = addThinking();

    const t0 = performance.now();
    try {
      const res = await fetch(`${API_BASE}/v1/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      const elapsed = Math.round(performance.now() - t0);

      removeThinking();

      if (data.error) {
        addMsg('ai', 'âš  ' + data.error.message, null);
      } else {
        const content = data.choices[0].message.content;
        messages.push({ role: 'assistant', content });
        addMsg('ai', content, elapsed, data.usage);
        showStats(elapsed, data.usage);
      }
    } catch (err) {
      removeThinking();
      addMsg('ai', 'âš  Connection error: ' + err.message, null);
    }

    setStatus('online');
    document.getElementById('send-btn').disabled = false;
    input.focus();
  }

  // â”€â”€ DOM HELPERS â”€â”€
  function addMsg(role, content, ms, usage) {
    messages.push({ role: role === 'user' ? 'user' : 'assistant', content });

    const chat = document.getElementById('chat');
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

    const label = document.createElement('div');
    label.className = 'msg-label';
    label.textContent = role === 'user' ? 'YOU' : 'ðŸ¦€ FABIO-CLAW';

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = content;

    wrap.appendChild(label);
    wrap.appendChild(bubble);

    if (ms !== null && ms !== undefined) {
      const meta = document.createElement('div');
      meta.className = 'msg-meta';
      meta.textContent = `${ms}ms`;
      if (usage) meta.textContent += ` Â· ${usage.total_tokens} tokens`;
      wrap.appendChild(meta);
    }

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return wrap;
  }

  function addThinking() {
    const chat = document.getElementById('chat');
    const wrap = document.createElement('div');
    wrap.className = 'msg ai';
    wrap.id = 'thinking-indicator';

    const label = document.createElement('div');
    label.className = 'msg-label';
    label.textContent = 'ðŸ¦€ FABIO-CLAW';

    const bubble = document.createElement('div');
    bubble.className = 'thinking-bubble';
    bubble.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';

    wrap.appendChild(label);
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return wrap;
  }

  function removeThinking() {
    const el = document.getElementById('thinking-indicator');
    if (el) el.remove();
    thinking = null;
  }

  function showStats(ms, usage) {
    if (!usage) return;
    document.getElementById('stats').classList.add('visible');
    document.getElementById('stat-time').textContent = ms;
    document.getElementById('stat-prompt').textContent = usage.prompt_tokens;
    document.getElementById('stat-completion').textContent = usage.completion_tokens;
    document.getElementById('stat-total').textContent = usage.total_tokens;
  }

  function clearChat() {
    messages = [];
    const chat = document.getElementById('chat');
    chat.innerHTML = '<div class="sys-banner">FABIO-CLAW v0.1.0 // CHAT CLEARED</div>';
    document.getElementById('stats').classList.remove('visible');
  }

  // â”€â”€ KEYBOARD â”€â”€
  document.getElementById('input').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!document.getElementById('send-btn').disabled) sendMessage();
    }
  });

  // Auto-resize textarea
  document.getElementById('input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
  });

  init();
</script>
</body>
</html>
